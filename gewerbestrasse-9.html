<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Funk√ºbung ‚Äì Station: Gewerbestra√üe 9 (Dorfborn, GT√ú)</title>
  <style>
    :root { --brand:#c62828; --ok:#2e7d32; --warn:#c62828; --bg:#f7f8fb; --card:#ffffff; --border:#e5e7ef; --text:#111; --muted:#555; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;margin:0;padding:16px;line-height:1.5;background:var(--bg);color:var(--text);}
    .card{max-width:860px;margin:auto;background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:0 1px 10px rgba(0,0,0,.06);}
    .header{display:flex;align-items:center;gap:10px;padding:16px;border-bottom:1px solid var(--border);}
    .icon{font-size:28px;}
    .wrap{padding:16px;}
    .status{padding:12px;border-left:8px solid var(--warn);border-radius:10px;margin-top:10px;}
    .status.ok{border-left-color:var(--ok);}
    .btn{margin-top:10px;padding:.7rem 1.2rem;font-weight:700;border-radius:10px;border:2px solid var(--warn);color:var(--warn);background:#fff;cursor:pointer;}
    .btn.success{background:var(--ok);color:#fff;border-color:var(--ok);}
    .task{margin-top:20px;border:1px dashed var(--border);padding:14px;border-radius:10px;}
    .task h2{text-decoration:underline;color:var(--brand);}
    .muted{color:var(--muted);}
    .gate{margin-top:14px;border:1px solid var(--border);padding:12px;border-radius:10px;}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;}
    input[type="text"]{padding:.6rem .7rem;border:1px solid var(--border);border-radius:10px;min-width:200px;}
    .imgwrap img{max-width:100%;height:auto;border:1px solid var(--border);border-radius:10px}
  </style>
</head>
<body>
  <div class="card">
    <div class="header">
      <div class="icon">üöí</div>
      <h1>Funk√ºbung ‚Äì Station: Gewerbestra√üe 9 (Dorfborn, GT√ú)</h1>
    </div>
    <div class="wrap">
      <div id="status" class="status warn"><strong>Status:</strong> Noch kein Standort gepr√ºft.</div>
      <button id="btn" class="btn danger">Standort pr√ºfen</button>

      <div id="content" style="display:none">
        <div class="task">
          <h2>Hinweis &amp; Aufgabe</h2>
          <p><strong>Aufgabe:</strong> BMA ausgel√∂st: Lagemeldung &amp; Ma√ünahmen, ggf. Kr√§fte nachfordern.</p>
          <p><strong>Hinweis-Buchstabe:</strong> <span id="hint">‚Äî</span> <span class="muted">(wird nach Code-Freischaltung angezeigt)</span></p>

          <!-- BMA-Bildblock (wird nach erfolgreicher Standortpr√ºfung je FHZ sofort angezeigt) -->
          <div id="bmaBlock" class="imgwrap" style="display:none;margin-top:10px">
            <a id="bmaLink" href="#" target="_blank" rel="noopener">
              <img id="bmaImg" src="#" alt="Lagebild: BMA">
            </a>
            <div class="muted">Lagebild: <a id="bmaOpen" href="#" target="_blank" rel="noopener">√ñffnen</a></div>
          </div>
        </div>

        <div id="codeGate" class="gate" style="display:none">
          <h3 style="margin:0 0 6px 0;">Freischaltung per Positionscode</h3>
          <p class="muted">Gib den von der √úbungsleitung vergebenen Positionscode ein.</p>
          <div class="row">
            <input id="codeInput" type="text" inputmode="text" autocomplete="off" placeholder="Positionscode">
            <button id="codeBtn" class="btn danger" type="button">Code pr√ºfen</button>
          </div>
          <div id="codeMsg" class="muted" style="margin-top:8px;"></div>
        </div>
      </div>

      <details>
        <summary>Koordinaten</summary>
        <p class="muted"><strong>Koordinaten (WGS84):</strong> 50.450764, 9.614117<br><strong>Radius:</strong> 60 m</p>
      </details>
    </div>
  </div>

<script>
// Geofence
const TARGET_LAT = 50.450764;
const TARGET_LNG = 9.614117;
const RADIUS_M = 60;

// FHZ aus URL (z. B. ?fhz=1 .. ?fhz=6)
const qs = new URLSearchParams(location.search);
const fhzRaw = (qs.get("fhz") || "").trim();
const FHZ = /^[1-6]$/.test(fhzRaw) ? fhzRaw : ""; // nur 1..6 zulassen

// Code-Mapping: Positionscode -> Buchstabe (aus 6-FHZ-Variante)
// Hinweis: "/" wird sowohl in der Eingabe als auch hier NICHT verwendet.
const CODE_TO_LETTER = {
  "W1P5": "N",
  "W2P4": "R",
  "W3P3": "S",
  "W4P2": "‚ê£ (Leerzeichen)",
  "W5P1": "L",
  "W6P8": "‚ê£ (Leerzeichen)"
};

// FHZ -> BMA-Bild (URLs je FHZ )
const FHZ_TO_IMAGE = {
  "1": "https://daniel911211.github.io/Bilder/BMA-Anzeige-Meldergruppe_10.jpg",
  "2": "https://daniel911211.github.io/Bilder/BMA-Anzeige-Meldergruppe_18.jpg",
  "3": "https://daniel911211.github.io/Bilder/BMA-Anzeige-Meldergruppe_5.jpg",
  "4": "https://daniel911211.github.io/Bilder/BMA-Anzeige-Meldergruppe_57.png",
  "5": "https://daniel911211.github.io/Bilder/BMA-Anzeige-Meldergruppe_60.jpg",
  "6": "https://daniel911211.github.io/Bilder/BMA-Anzeige-Meldergruppe_7.jpg"
};

// Elemente
const statusBox = document.getElementById("status");
const btn = document.getElementById("btn");
const content = document.getElementById("content");
const codeGate  = document.getElementById("codeGate");
const codeInput = document.getElementById("codeInput");
const codeBtn   = document.getElementById("codeBtn");
const codeMsg   = document.getElementById("codeMsg");
const hintSpan  = document.getElementById("hint");
const bmaBlock = document.getElementById("bmaBlock");
const bmaImg   = document.getElementById("bmaImg");
const bmaLink  = document.getElementById("bmaLink");
const bmaOpen  = document.getElementById("bmaOpen");

// Haversine
function haversine(lat1, lon1, lat2, lon2){
  const toRad = d => d * Math.PI / 180;
  const R = 6371000;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lat2 == lat1 ? 0 : (lon2 - lon1)); // robust
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(toRad(lon2 - lon1)/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

// UI-Helfer
function setStatusOk(text){
  statusBox.classList.remove("warn");
  statusBox.classList.add("ok");
  statusBox.innerHTML = `<strong>Status:</strong> ${text}`;
  btn.classList.add("success");
}
function setStatusWarn(text){
  statusBox.classList.remove("ok");
  statusBox.classList.add("warn");
  statusBox.innerHTML = `<strong>Status:</strong> ${text}`;
  btn.classList.remove("success");
}

// Bei jeder Standortpr√ºfung: Buchstaben/Code/Bild zur√ºcksetzen
function lockGate(){
  hintSpan.textContent = "‚Äî";
  codeInput.value = "";
  codeMsg.textContent = "";
  codeGate.style.display = "none";
  if (bmaBlock) bmaBlock.style.display = "none";
}

// Freischalten: Buchstabe (fett+rot)
function unlock(letter) {
  hintSpan.innerHTML = `<strong style="color:#c62828;">${letter}</strong>`;
  codeGate.style.display = "none";
}

// Standort pr√ºfen
btn.addEventListener("click", () => {
  if(!navigator.geolocation){
    setStatusWarn("Geolocation wird nicht unterst√ºtzt.");
    return;
  }
  // Bei jeder neuen Pr√ºfung: zur√ºcksetzen
  lockGate();

  setStatusWarn("Bitte Standortfreigabe erlauben ‚Ä¶");
  navigator.geolocation.getCurrentPosition(pos => {
    const { latitude, longitude, accuracy } = pos.coords;
    const dist = haversine(latitude, longitude, TARGET_LAT, TARGET_LNG);
    if(dist <= RADIUS_M){
      setStatusOk(`Am richtigen Ort (‚âà ${Math.round(dist)} m, Genauigkeit ¬±${Math.round(accuracy)} m).`);
      content.style.display = "block";

      // >>> BMA-Bild sofort einblenden (je nach FHZ)
      const imgUrl = FHZ_TO_IMAGE[FHZ];
      if (imgUrl && bmaBlock && bmaImg && bmaLink && bmaOpen) {
        bmaImg.src = imgUrl;
        bmaLink.href = imgUrl;
        bmaOpen.href = imgUrl;
        bmaBlock.style.display = "block";
      }

      // Codefeld anzeigen ‚Äì Buchstabe bleibt verborgen bis korrekter Code
      codeGate.style.display = "block";
    } else {
      setStatusWarn(`Nicht am richtigen Ort (Entfernung ‚âà ${Math.round(dist)} m, Zielradius ${RADIUS_M} m).`);
      content.style.display = "none";
    }
  }, err => {
    setStatusWarn("Standort konnte nicht ermittelt werden oder Zugriff verweigert.");
  }, { enableHighAccuracy:true, timeout:15000, maximumAge:0 });
});

// Codepr√ºfung
let tries = 0;
if (codeBtn) {
  codeBtn.addEventListener("click", () => {
    const val = (codeInput.value || "")
      .toUpperCase()
      .trim()
      .replace(/[\/\s]/g, ""); // "/" und Leerzeichen entfernen

    if (!val) { codeMsg.textContent = "Bitte Positionscode eingeben."; return; }

    // Wenn irgendwo noch "‚ê£" ohne Zusatz stehen sollte, im Mapping vereinheitlichen:
    const letterRaw = CODE_TO_LETTER[val] || null;
    const letter = (letterRaw === "‚ê£") ? "‚ê£ (Leerzeichen)" : letterRaw;

    if (letter) {
      codeMsg.textContent = "Freigeschaltet ‚úÖ";
      unlock(letter);
    } else {
      tries++;
      codeMsg.textContent = `Falscher Code ‚ùå (Versuch ${tries}).`;
      if (tries >= 3) {
        codeMsg.textContent += " Warte 15 Sekunden ‚Ä¶";
        codeBtn.disabled = true;
        setTimeout(() => { codeBtn.disabled = false; codeMsg.textContent = ""; tries = 0; }, 15000);
      }
    }
  });
}
</script>
</body>
</html>
