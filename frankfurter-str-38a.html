<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Funkübung – Station: Frankfurter Str. 38A (Neuhof)</title>
  <style>
    :root { --brand:#c62828; --ok:#2e7d32; --warn:#c62828; --bg:#f7f8fb; --card:#ffffff; --border:#e5e7ef; --text:#111; --muted:#555; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;margin:0;padding:16px;line-height:1.5;background:var(--bg);color:var(--text);}
    .card{max-width:860px;margin:auto;background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:0 1px 10px rgba(0,0,0,.06);}
    .header{display:flex;align-items:center;gap:10px;padding:16px;border-bottom:1px solid var(--border);}
    .icon{font-size:28px;}
    .wrap{padding:16px;}
    .status{padding:12px;border-left:8px solid var(--warn);border-radius:10px;margin-top:10px;}
    .status.ok{border-left-color:var(--ok);}
    .btn{margin-top:10px;padding:.7rem 1.2rem;font-weight:700;border-radius:10px;border:2px solid var(--warn);color:var(--warn);background:#fff;cursor:pointer;}
    .btn.success{background:var(--ok);color:#fff;border-color:var(--ok);}
    .task{margin-top:20px;border:1px dashed var(--border);padding:14px;border-radius:10px;}
    .task h2{text-decoration:underline;color:var(--brand);}
    .muted{color:var(--muted);}
    .gate{margin-top:14px;border:1px solid var(--border);padding:12px;border-radius:10px;}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;}
    input[type="text"]{padding:.6rem .7rem;border:1px solid var(--border);border-radius:10px;min-width:220px;}
    .out strong{color:#c62828;}
  </style>
</head>
<body>
  <div class="card">
    <div class="header">
      <div class="icon">🚒</div>
      <h1>Funkübung – Station: Frankfurter Str. 38A (Neuhof)</h1>
    </div>
    <div class="wrap">
      <div id="status" class="status warn"><strong>Status:</strong> Noch kein Standort geprüft.</div>
      <button id="btn" class="btn danger">Standort prüfen</button>

      <div id="content" style="display:none">
        <div class="task">
          <h2>Hinweis &amp; Aufgabe</h2>
          <p><strong>Aufgabe:</strong> Meldet euch über Funk bei der Übungsleitung. Ihr erhaltet ein <em>Abfragewort</em>. Gebt es unten ein, um eure Aufgabe anzeigen zulassen.</p>
          <p><strong>Hinweis-Buchstabe:</strong> <span id="hint">—</span> <span class="muted"></span></p>

          <!-- Freischaltung per Abfragewort -->
          <div id="wordGate" class="gate" style="display:none">
            <h3 style="margin:0 0 6px 0;">Freischaltung per Abfragewort</h3>
            <p class="muted">Abfragewort von der Übungsleitung eingeben (Groß-/Kleinschreibung egal).</p>
            <div class="row">
              <input id="wordInput" type="text" autocomplete="off" placeholder="Abfragewort">
              <button id="wordBtn" class="btn danger" type="button">Wort prüfen</button>
            </div>
            <div id="wordMsg" class="muted" style="margin-top:8px;"></div>
          </div>

          <!-- Ausgabe nach Freischaltung -->
          <div id="out" class="out" style="display:none; margin-top:12px">
            <p><strong>Anzurufendes FHZ:</strong> <span id="outCall"></span></p>
            <p><strong>Frage:</strong> <span id="outQuestion"></span></p>
            <p><strong>Lösungsbuchstabe:</strong> <strong id="outLetter"></strong></p>
            <p><strong>Positionscode:</strong> <strong id="outCode"></strong></p>
          </div>
        </div>
      </div>

      <details>
        <summary>Koordinaten</summary>
        <p class="muted"><strong>Koordinaten (WGS84):</strong> 50.450764, 9.614117<br><strong>Radius:</strong> 60 m</p>
      </details>
    </div>
  </div>

<script>
// === Geofence ===
const TARGET_LAT = 50.450764;
const TARGET_LNG = 9.614117;
const RADIUS_M   = 60;

// === Abfragewörter → Payload ===
// Diese Tabelle pflegen: Wort -> { call, question, letter, code }
const WORD_PAYLOAD = {
  "Anton":   { call:"FHZ 2", question:"Welche Pumpe ist im TSF verbaut?",                                  letter:"I", code:"W1P8" },
  "Berta":   { call:"FHZ 3", question:"Wie viele Einsatzkräfte kann euer Fahrzeug maximal aufnehmen?",    letter:"U", code:"W2P7" },
  "Cäsar": { call:"FHZ 4", question:"Welche Materialien/Ausrüstungen transportiert ihr mit dem GW-L?",  letter:"A", code:"W3P6" },
  "Dora":   { call:"FHZ 5", question:"Wie viele Saugschläuche führt euer Fahrzeug mit?",                 letter:"A", code:"W4P5" },
  "Emil":    { call:"FHZ 6", question:"Welche technischen Geräte nutzt ihr zur Menschenrettung bei VU?",  letter:"E", code:"W5P4" },
  "Friedrich": { call:"FHZ 1", question:"Welche Aufgaben hat der Einsatzleitwagen an der Einsatzstelle?",   letter:"E", code:"W6P3" }
};
// Optional: ihr könnt auch z. B. "ALFA" zusätzlich auf "ALPHA" mappen:
WORD_PAYLOAD["ALFA"] = WORD_PAYLOAD["ALPHA"];

// === Elemente ===
const statusBox = document.getElementById("status");
const btn       = document.getElementById("btn");
const content   = document.getElementById("content");

const wordGate  = document.getElementById("wordGate");
const wordInput = document.getElementById("wordInput");
const wordBtn   = document.getElementById("wordBtn");
const wordMsg   = document.getElementById("wordMsg");

const outBox    = document.getElementById("out");
const outCall   = document.getElementById("outCall");
const outQ      = document.getElementById("outQuestion");
const outLetter = document.getElementById("outLetter");
const outCode   = document.getElementById("outCode");
const hintSpan  = document.getElementById("hint");

// === Haversine ===
function haversine(lat1, lon1, lat2, lon2){
  const toRad = d => d * Math.PI / 180, R = 6371000;
  const dLat = toRad(lat2 - lat1), dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

// === UI-Helfer ===
function setStatusOk(text){  statusBox.classList.remove("warn"); statusBox.classList.add("ok");  statusBox.innerHTML = `<strong>Status:</strong> ${text}`; btn.classList.add("success"); }
function setStatusWarn(text){statusBox.classList.remove("ok");   statusBox.classList.add("warn");statusBox.innerHTML = `<strong>Status:</strong> ${text}`; btn.classList.remove("success"); }

function resetGate(){
  hintSpan.textContent = "—";
  wordInput.value = "";
  wordMsg.textContent = "";
  wordGate.style.display = "none";
  outBox.style.display = "none";
}

// === Standort prüfen ===
btn.addEventListener("click", () => {
  if(!navigator.geolocation){ setStatusWarn("Geolocation wird nicht unterstützt."); return; }
  resetGate();

  setStatusWarn("Bitte Standortfreigabe erlauben …");
  navigator.geolocation.getCurrentPosition(pos => {
    const { latitude, longitude, accuracy } = pos.coords;
    const dist = haversine(latitude, longitude, TARGET_LAT, TARGET_LNG);
    if(dist <= RADIUS_M){
      setStatusOk(`Am richtigen Ort (≈ ${Math.round(dist)} m, Genauigkeit ±${Math.round(accuracy)} m).`);
      content.style.display = "block";
      wordGate.style.display = "block";     // Abfragewort jetzt erlauben
    } else {
      setStatusWarn(`Nicht am richtigen Ort (Entfernung ≈ ${Math.round(dist)} m, Zielradius ${RADIUS_M} m).`);
      content.style.display = "none";
    }
  }, err => {
    setStatusWarn("Standort konnte nicht ermittelt werden oder Zugriff verweigert.");
  }, { enableHighAccuracy:true, timeout:15000, maximumAge:0 });
});

// === Abfragewort prüfen ===
let tries = 0;
wordBtn.addEventListener("click", () => {
  const key = (wordInput.value || "").toUpperCase().trim().replace(/\s+/g,"");
  if(!key){ wordMsg.textContent = "Bitte Abfragewort eingeben."; return; }

  const payload = WORD_PAYLOAD[key];
  if(payload){
    wordMsg.textContent = "Freigeschaltet ✅";
    // Ausgabe füllen
    outCall.textContent   = payload.call;
    outQ.textContent      = payload.question;
    outLetter.textContent = payload.letter;   // fett/rot via CSS
    outCode.textContent   = payload.code;     // fett/rot via CSS
    hintSpan.innerHTML    = `<strong style="color:#c62828;">${payload.letter}</strong>`;
    outBox.style.display  = "block";
  }else{
    tries++;
    wordMsg.textContent = `Falsches Wort ❌ (Versuch ${tries}).`;
    if(tries >= 3){
      wordMsg.textContent += " Warte 15 Sekunden …";
      wordBtn.disabled = true;
      setTimeout(() => { wordBtn.disabled = false; wordMsg.textContent = ""; tries = 0; }, 15000);
    }
  }
});
</script>
</body>
</html>
